# Configuration Helm pour le service FRONTEND en environnement DEV
# Ce fichier surcharge les valeurs par défaut du chart générique

# ============================================================================
# IDENTIFICATION
# ============================================================================
name: frontend  # Nom du service (utilisé pour Deployment, Service, etc.)

# ============================================================================
# RÉPLICATION
# ============================================================================
replicaCount: 1  # DEV: 1 seul replica (économie de ressources)
                 # PROD: 3 replicas (haute disponibilité)

# ============================================================================
# IMAGE DOCKER
# ============================================================================
image:
  repository: gcr.io/google-samples/microservices-demo  # Google Container Registry
  tag: v0.10.1  # Version stable de l'application
  pullPolicy: IfNotPresent  # Utilise l'image locale si disponible

# ============================================================================
# SERVICE KUBERNETES
# ============================================================================
service:
  type: ClusterIP  # Interne au cluster
  port: 80         # Port externe du service (standard HTTP)
  targetPort: 8080 # Port sur lequel l'application écoute dans le container

# ============================================================================
# RESSOURCES CPU/MÉMOIRE
# ============================================================================
resources:
  limits:
    cpu: 200m      # DEV: ressources limitées
    memory: 128Mi  # PROD: ressources plus élevées (300m CPU, 256Mi RAM)
  requests:
    cpu: 100m      # Ressources garanties
    memory: 64Mi

# ============================================================================
# HEALTH CHECKS (Probes)
# ============================================================================
livenessProbe:
  enabled: true
  httpGet:
    path: /_healthz  # Endpoint de health check du frontend
    port: 8080       # Port applicatif
  initialDelaySeconds: 10  # Attendre 10s avant le 1er check
  periodSeconds: 10        # Vérifier toutes les 10s

readinessProbe:
  enabled: true
  httpGet:
    path: /_healthz  # Vérifie que le frontend est prêt à servir des requêtes
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 10

# ============================================================================
# VARIABLES D'ENVIRONNEMENT
# ============================================================================
env:
  # Port d'écoute de l'application
  - name: PORT
    value: "8080"
  
  # Adresses des services backend (service-name:port)
  # Format: nom-du-service-kubernetes:port
  - name: PRODUCT_CATALOG_SERVICE_ADDR
    value: "productcatalogservice:3550"  # Catalogue produits (gRPC)
  - name: CURRENCY_SERVICE_ADDR
    value: "currencyservice:7000"  # Conversion de devises (gRPC)
  - name: CART_SERVICE_ADDR
    value: "cartservice:7070"  # Panier d'achat (gRPC)
  - name: RECOMMENDATION_SERVICE_ADDR
    value: "recommendationservice:8080"  # Recommandations (gRPC)
  - name: SHIPPING_SERVICE_ADDR
    value: "shippingservice:50051"  # Livraison (gRPC)
  - name: CHECKOUT_SERVICE_ADDR
    value: "checkoutservice:5050"  # Paiement (gRPC)
  - name: AD_SERVICE_ADDR
    value: "adservice:9555"  # Publicités (gRPC)
  - name: SHOPPING_ASSISTANT_SERVICE_ADDR
    value: "shoppingassistantservice:80"  # Assistant (optionnel)

  # Désactivation des services Google Cloud (nécessitent GCP)
  # Sans ces variables, l'app crash en tentant de se connecter à GCP
  - name: DISABLE_PROFILER
    value: "1"  # Désactive Google Cloud Profiler (monitoring)
  - name: DISABLE_TRACING
    value: "1"  # Désactive Google Cloud Trace (APM)
# ============================================================================
# AUTOSCALING (Horizontal Pod Autoscaler)
# ============================================================================
autoscaling:
  enabled: true  # Activé même en DEV pour tester le comportement
  minReplicas: 1  # DEV: minimum 1 pod
  maxReplicas: 3  # DEV: maximum 3 pods (PROD: 10 pods)
  targetCPUUtilizationPercentage: 70     # Scale up si CPU > 70%
  targetMemoryUtilizationPercentage: 80  # Scale up si RAM > 80%

# ============================================================================
# POD DISRUPTION BUDGET (Résilience)
# ============================================================================
podDisruptionBudget:
  enabled: true    # Garantit disponibilité pendant maintenances
  minAvailable: 1  # Au moins 1 pod doit rester disponible

# ============================================================================
# LABELS (Organisation et filtrage)
# ============================================================================
labels:
  app.kubernetes.io/part-of: online-boutique  # Groupe logique d'applications
  environment: dev  # Environnement (dev vs prod)

# ============================================================================
# RBAC (Permissions Kubernetes)
# ============================================================================
# Activer ServiceAccount + RBAC pour accès lecture aux ressources
serviceAccount: true  # Crée un ServiceAccount dédié
rbac:
  enabled: true  # Active les règles RBAC
  rules:
    # Permissions minimales (principe du moindre privilège)
    - apiGroups: [""]  # Core API group
      resources: ["pods", "services"]  # Lire pods et services
      verbs: ["get", "list"]  # Seulement lecture, pas d'écriture

# ============================================================================
# INGRESS (Exposition HTTP)
# ============================================================================
ingress:
  enabled: true  # Expose le frontend via Ingress (HTTP)
  className: "nginx"  # Utilise NGINX Ingress Controller
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /  # Réécriture d'URL
  hosts:
    - host: dev.online-boutique.local  # Hostname (ajouter à /etc/hosts)
      paths:
        - path: /  # Route racine
          pathType: Prefix
  tls: []  # Pas de TLS/SSL en DEV (HTTPS non configuré)

